import{a as m}from"./chunk-4W6XZAEZ.js";import{a as c,d as h}from"./chunk-3F3ZFDNX.js";import{C as i,W as l,aa as p,m as d,q as o}from"./chunk-U346BHW4.js";var n={USERS:"users",USER_BY_ID:s=>`users/${s}`,ADD:"users/add/",UPDATE:s=>`users/update/${s}`,CHANGE_PASSWORD:s=>`users/update/${s}/password`,DELETE:s=>`users/delete/${s}`,BAN:s=>`users/ban/${s}`,UNBAN:s=>`users/unban/${s}`,RECOVER_PASSWORD:"users/update/petition/password",VERIFY_DNI:"users/verify/dni",VERIFY_CODE:"usersupdate/verify/code",UPDATE_PASSWORD:"users/update/confirm/password"};var u=class s{apiService=p(h);logger=p(c);storage=p(m);getUsers(){return this.apiService.get(n.USERS,{withCredentials:!0}).pipe(o(r=>r||[]),i(r=>this.handleError("Get users",r)))}getUserById(r){return this.apiService.get(n.USER_BY_ID(r),{withCredentials:!0}).pipe(i(e=>this.handleError("Get user by ID",e)))}createUser(r){let e=new FormData;return e.append("username",r.username),e.append("dni",r.dni),e.append("email",r.email),e.append("password",r.password),r.health_insurance&&r.health_insurance.length>0&&r.health_insurance.forEach(t=>e.append("health_insurance_id",t)),e.append("blood_type",r.blood_type),e.append("first_name",r.first_name),e.append("last_name",r.last_name),e.append("telephone",r.telephone||""),this.logger.debug("Creating user with data:",e),this.apiService.post(n.ADD,e,{withCredentials:!0}).pipe(i(t=>this.handleError("Create user",t)))}updateUser(r,e){let t=new FormData;return t.append("username",e.username||""),t.append("first_name",e.first_name||""),t.append("last_name",e.last_name||""),t.append("telephone",e.telephone||""),t.append("address",e.address||""),e.health_insurance&&e.health_insurance.length>0&&e.health_insurance.forEach(a=>t.append("health_insurance_id",a)),e.img_profile instanceof File&&t.append("img_profile",e.img_profile,e.img_profile.name),this.apiService.patch(n.UPDATE(r),t,{withCredentials:!0}).pipe(i(a=>this.handleError(`Update user ${r}`,a)))}changePassword(r,e){return this.apiService.patch(n.CHANGE_PASSWORD(r),e).pipe(o(t=>t.user),i(t=>this.handleError(`Change password for user ${r}`,t)))}deleteUser(r){return this.apiService.delete(n.DELETE(r),{withCredentials:!0}).pipe(i(e=>this.handleError("Delete user",e)))}banUser(r){return this.apiService.patch(n.BAN(r),{},{withCredentials:!0}).pipe(o(e=>e.user),i(e=>this.handleError("Ban user",e)))}unbanUser(r){return this.apiService.patch(n.UNBAN(r),{},{withCredentials:!0}).pipe(o(e=>e.user),i(e=>this.handleError("Unban user",e)))}petitionRecoverPassword(r){let e=`email=${encodeURIComponent(r)}`;return this.apiService.post(n.RECOVER_PASSWORD,e,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).pipe(i(t=>this.handleError("Petition recover password",t)))}verifyDni(r,e){let t=new FormData;return t.append("front",r,r.name),t.append("back",e,e.name),this.apiService.post(n.VERIFY_DNI,t).pipe(i(a=>this.handleError("Verify DNI",a)))}verifyCode(r,e){let t=`email=${encodeURIComponent(r)}&code=${encodeURIComponent(e)}`;return this.apiService.post(n.VERIFY_CODE,t,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).pipe(i(a=>this.handleError("Verify code",a)))}updatePassword(r,e,t){let a=`email=${encodeURIComponent(r)}&code=${encodeURIComponent(e)}&new_password=${encodeURIComponent(t)}`;return this.apiService.post(n.UPDATE_PASSWORD,a,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).pipe(i(f=>this.handleError("Update password",f)))}handleError(r,e){this.logger.error(`${r} failed`,e);let t="An unexpected error occurred";if(e instanceof Error)t=e.message;else if(typeof e=="object"&&e!==null&&"status"in e){let a=e;switch(a.status){case 400:t=this.formatErrorDetail(a.error?.detail)??"Invalid request data";break;case 401:t=this.formatErrorDetail(a.error?.detail)??"Unauthorized access",this.storage.clearScopes();break;case 403:t=this.formatErrorDetail(a.error?.detail)??"Forbidden action";break;case 404:t=this.formatErrorDetail(a.error?.detail)??"Resource not found";break;case 422:t=this.formatErrorDetail(a.error?.detail)??"Invalid data format";break;default:t=this.formatErrorDetail(a.error?.detail)??"Server error"}}return d(()=>new Error(t))}formatErrorDetail(r){if(typeof r=="string")return r;if(Array.isArray(r))return r.map(e=>`${e.loc.join(".")} (${e.type}): ${e.msg}`).join("; ")}static \u0275fac=function(e){return new(e||s)};static \u0275prov=l({token:s,factory:s.\u0275fac,providedIn:"root"})};export{u as a};
