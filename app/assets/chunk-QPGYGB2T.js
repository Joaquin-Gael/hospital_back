import{a as O}from"./chunk-PC5HHMPZ.js";import{a as v,b as m,d as T}from"./chunk-J2GLTX2R.js";import{a as l}from"./chunk-GGYCCLGV.js";import{B as t,Q as b,R as p,T as h,W as k,aa as g,g as S,i as f,k as n,l as d,p as c}from"./chunk-VYPP3LKO.js";var o={LOGIN:"auth/login",OAUTH_LOGIN:a=>`/oauth/${a}/`,DOC_LOGIN:"auth/doc/login",DECODE:"/auth/decode/",REFRESH:"auth/refresh",LOGOUT:"auth/logout",SCOPES:"auth/scopes",ME:"users/me"};var E=class a{apiService=g(T);storage=g(O);logger=g(v);apiBaseUrl=g(m);loginStatusSubject=new S(this.isLoggedIn());loginStatus$=this.loginStatusSubject.asObservable();isLoggedIn(){return!!this.storage.getAccessToken()}login(e){let r=new l().set("email",e.email).set("password",e.password);return this.apiService.post(o.LOGIN,r.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).pipe(p(s=>(this.persistSessionTokens(s.access_token,s.refresh_token,"login"),this.hydrateScopes(s))),t(s=>this.handleError("User Login",s)))}oauthLogin(e){let r=`${this.apiBaseUrl}${o.OAUTH_LOGIN(e)}`;this.logger.debug(`Redirigiendo a OAuth para ${e}: ${r}`),window.location.href=r}exchangeCodeForToken(e){let r=`${this.apiBaseUrl}/api/oauth/google`;return this.logger.debug(`Intercambiando c\xF3digo en: ${r}`),this.apiService.post(r,{code:e}).pipe(p(s=>(this.logger.debug("Token recibido:",s.access_token),this.persistSessionTokens(s.access_token,s.refresh_token,"OAuth login"),this.hydrateScopes(s))),t(s=>this.handleError("OAuth Code Exchange",s)))}decode(e){return this.logger.debug("Decodificando c\xF3digo secreto"),this.apiService.post(o.DECODE,{code:e}).pipe(p(r=>(this.logger.debug("Access token recibido:",r.access_token),this.persistSessionTokens(r.access_token,null,"code decode"),this.hydrateScopes(r))),t(r=>this.handleError("Decode Code",r)))}storeAccessToken(e){if(this.logger.debug("Almacenando access_token:",e),!this.storage.setAccessToken(e))return this.logger.error("No se pudo almacenar el access_token"),d(()=>new Error("No se pudo almacenar el access_token"));let s=this.storage.getAccessToken();return this.logger.debug("Token almacenado correctamente:",s),this.loginStatusSubject.next(!0),n(void 0)}doctorLogin(e){let r=new l().set("email",e.email).set("password",e.password);return this.apiService.post(o.DOC_LOGIN,r.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).pipe(p(s=>(this.persistSessionTokens(s.access_token,s.refresh_token,"doctor login"),this.hydrateScopes(s))),t(s=>this.handleError("Doctor Login",s)))}getUser(){return this.isLoggedIn()?this.apiService.get(o.ME).pipe(c(e=>e?.user??null),t(()=>n(null))):n(null)}logout(){return this.isLoggedIn()?this.apiService.delete(o.LOGOUT).pipe(h(()=>{this.clearSession()}),c(()=>{}),t(e=>(this.logger.warn("Logout request failed",e),this.clearSession(),n(void 0)))):(this.clearSession(),n(void 0))}refreshToken(){let e=this.storage.getRefreshToken();e||(this.clearSession(),this.logger.error("No refresh token available "));let r={headers:{Authorization:`Bearer ${e}`}};return this.apiService.get(o.REFRESH,r).pipe(h(s=>{this.persistSessionTokens(s.access_token,s.refresh_token,"refresh")}),t(s=>this.handleError("Refresh token",s)))}getScopes(){return this.apiService.get(o.SCOPES).pipe(c(e=>e.scopes),t(()=>n([])))}setScopes(e){this.storage.setItem("scopes",JSON.stringify(e))||this.logger.warn("Scopes could not be stored")}getStoredScopes(){let e=this.storage.getItem("scopes");return e?JSON.parse(e):[]}hydrateScopes(e){return this.apiService.get(o.SCOPES).pipe(h({next:r=>{this.setScopes(r.scopes)},error:()=>{this.setScopes([])}}),c(()=>e),b(e),t(()=>f))}persistSessionTokens(e,r,s){let i=this.storage.setAccessToken(e),u=!0;r&&(u=this.storage.setRefreshToken(r)),(!i||!u)&&this.logger.warn(`Tokens could not be stored after ${s}`),this.loginStatusSubject.next(!0)}clearSession(){this.storage.clearStorage(),this.loginStatusSubject.next(!1)}extractErrorDetail(e){if(typeof e=="string")return e;if(e&&typeof e=="object"){if("detail"in e&&typeof e.detail=="string")return e.detail;if("message"in e&&typeof e.message=="string")return e.message}}handleError(e,r){this.logger.error(`${e} failed`,r);let s=this.extractErrorDetail(r.error),i="Ocurri\xF3 un error inesperado";switch(r.status){case 400:i=s??"Datos de solicitud inv\xE1lidos";break;case 401:case 403:i=s??"Credenciales inv\xE1lidas",this.clearSession();break;case 404:i=s??"Recurso no encontrado";break;default:i=s??"Error del servidor";break}return d(()=>new Error(i))}static \u0275fac=function(r){return new(r||a)};static \u0275prov=k({token:a,factory:a.\u0275fac,providedIn:"root"})};export{E as a};
