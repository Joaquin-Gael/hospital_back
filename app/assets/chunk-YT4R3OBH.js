import{a as J,b as K}from"./chunk-DU45OWEQ.js";import{a as q}from"./chunk-5MLIVNNP.js";import{a as U}from"./chunk-5GFEN4HN.js";import"./chunk-QMYIRM4F.js";import{a as G}from"./chunk-KOR7JQL3.js";import{a as R}from"./chunk-FG3VCKV6.js";import{a as B}from"./chunk-SLWJMPZV.js";import"./chunk-2KUBWO5M.js";import"./chunk-4W6XZAEZ.js";import"./chunk-LZ2CXPXV.js";import"./chunk-M3FKVPZN.js";import{a as N}from"./chunk-3F3ZFDNX.js";import{d as F}from"./chunk-7KU7TUXL.js";import"./chunk-AT6ZLWLU.js";import"./chunk-SHF7GFMJ.js";import{$a as a,$b as V,Fb as h,Gb as k,I as P,Ib as D,Jb as E,Kb as o,Lb as r,Mb as p,Nb as I,Ob as T,Pb as M,Rb as f,Rc as L,S as u,Sb as c,Tc as $,Zc as j,aa as d,ac as i,bc as g,cc as A,f as O,ja as _,ka as x,la as v,lb as S,lc as z,ma as y,qb as b,rc as H,ta as w,zb as m}from"./chunk-U346BHW4.js";import"./chunk-4CLCTAJ7.js";var W=(n,t)=>({"status-badge--completed":n,"status-badge--cancelled":t});function X(n,t){n&1&&p(0,"app-loading-spinner",1),n&2&&m("message","Cargando historial...")}function Y(n,t){if(n&1&&(o(0,"div",3)(1,"p"),i(2),r()()),n&2){let e=c(2);a(2),g(e.error)}}function Z(n,t){n&1&&(I(0),p(1,"span",18),T())}function ee(n,t){n&1&&(v(),o(0,"svg",13),p(1,"path",19),r())}function te(n,t){if(n&1){let e=M();o(0,"tr")(1,"td")(2,"div",6)(3,"div",7),i(4),r(),o(5,"div",8),i(6),r()()(),o(7,"td"),i(8),r(),o(9,"td"),i(10),r(),o(11,"td")(12,"span",9),p(13,"span",10),i(14),r()(),o(15,"td",11)(16,"button",12),f("click",function(){let l=_(e).$implicit,C=c(3);return x(C.onViewDetails(l))}),v(),o(17,"svg",13),p(18,"path",14)(19,"path",15),r()(),y(),o(20,"button",16),f("click",function(){let l=_(e).$implicit,C=c(3);return x(C.onDownloadReceipt(l))}),b(21,Z,2,0,"ng-container",17)(22,ee,2,0,"ng-template",null,0,H),r()()()}if(n&2){let e=t.$implicit,s=V(23),l=c(3);a(4),g(l.formatShortDate(e.date)),a(2),g(e.time),a(2),g(e.specialty),a(2),g(e.doctorName),a(2),m("ngClass",z(9,W,e.state==="finished",e.state==="cancelled")),a(2),A(" ",l.getStateText(e.state)," "),a(6),m("disabled",l.isDownloading(e.turnId)),a(),m("ngIf",l.isDownloading(e.turnId))("ngIfElse",s)}}function ne(n,t){n&1&&(o(0,"tr")(1,"td",20)(2,"div",21)(3,"div",22),v(),o(4,"svg",13),p(5,"path",23),r()(),y(),o(6,"h2"),i(7,"No hay historial"),r(),o(8,"p"),i(9,"Tus citas anteriores aparecer\xE1n aqu\xED."),r()()()())}function oe(n,t){if(n&1&&(o(0,"div",4)(1,"table",5)(2,"thead")(3,"tr")(4,"th"),i(5,"Fecha"),r(),o(6,"th"),i(7,"Especialidad"),r(),o(8,"th"),i(9,"M\xE9dico"),r(),o(10,"th"),i(11,"Estado"),r(),o(12,"th"),i(13,"Acciones"),r()()(),o(14,"tbody"),D(15,te,24,12,"tr",null,k,!1,ne,10,0,"tr"),r()()()),n&2){let e=c(2);a(15),E(e.filteredAppointments)}}function re(n,t){if(n&1&&b(0,Y,3,1,"div",3)(1,oe,18,1,"div",4),n&2){let e=c();h(e.error?0:1)}}function ie(n,t){if(n&1){let e=M();o(0,"app-view-dialog",24),f("close",function(){_(e);let l=c();return x(l.closeViewDialog())}),r()}if(n&2){let e=c();m("isOpen",e.viewDialogOpen)("title",e.viewDialogTitle)("item",e.viewDialogItem)("columns",e.viewDialogColumns)}}var Q=class n{appointments=[];loading=!1;viewDetails=new w;downloadReceipt=new w;authService=d(R);notificationService=d(B);appointmentService=d(U);logger=d(N);router=d(F);turnDocumentsService=d(J);localAppointments=[];localLoading=!0;error=null;destroy$=new O;downloadingTurnIds=new Set;viewDialogOpen=!1;viewDialogItem={};viewDialogTitle="";viewDialogColumns=[{key:"reason",label:"Motivo"},{key:"date",label:"Fecha",format:t=>this.formatShortDate(t)},{key:"time",label:"Hora"},{key:"specialty",label:"Especialidad"},{key:"doctorName",label:"M\xE9dico"},{key:"state",label:"Estado",format:t=>this.getStateText(t)}];ngOnInit(){if(this.appointments.length>0){this.localAppointments=this.appointments.filter(t=>t.state!=="waiting"),this.localLoading=this.loading;return}if(!this.authService.isLoggedIn()){this.logger.info("Usuario no autenticado, redirigiendo a /login"),this.router.navigate(["/login"]);return}this.authService.getUser().pipe(u(this.destroy$)).subscribe({next:t=>{if(!t){this.error="No se encontraron datos del usuario",this.logger.error("No user data found"),this.router.navigate(["/login"]),this.localLoading=!1;return}this.loadAppointments(t.id)},error:t=>{this.error="Error al cargar los datos del usuario",this.localLoading=!1,this.logger.error("Failed to load user",t),this.router.navigate(["/login"])}})}loadAppointments(t){this.localLoading=!0,this.appointmentService.getTurnsByUserId(t).pipe(u(this.destroy$)).subscribe({next:e=>{this.localAppointments=this.mapTurnsToAppointments(e),this.localLoading=!1,this.logger.debug("History appointments loaded successfully",this.localAppointments)},error:e=>{this.error="Error al cargar el historial de turnos",this.localLoading=!1,this.logger.error("Error loading history appointments",e)}})}mapTurnsToAppointments(t){return t.filter(e=>e.state!=="waiting").map(e=>({id:e.appointment_id??e.id,reason:e.reason,turnId:e.id,date:e.date,time:e.time.split(":").slice(0,2).join(":"),specialty:e.service?.[0]?.name??"Sin especialidad",doctorName:e.doctor?`${e.doctor.first_name} ${e.doctor.last_name}`.trim():"Sin m\xE9dico asignado",state:e.state}))}get filteredAppointments(){return this.appointments.length>0?this.appointments.filter(t=>t.state!=="waiting"):this.localAppointments}formatShortDate(t){return new Date(t).toLocaleDateString("es-AR",{day:"2-digit",month:"2-digit",year:"2-digit"})}formatFullDate(t){return new Date(t).toLocaleDateString("es-AR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}getStateText(t){switch(t){case"finished":return"Completada";case"cancelled":return"Cancelada";case"confirmed":return"Confirmada";case"pending":return"Pendiente";default:return"Estado desconocido"}}onViewDetails(t){this.viewDialogItem=t,this.viewDialogTitle=`Detalles de la Cita - ${t.specialty}`,this.viewDialogOpen=!0,this.logger.debug("Opening view dialog for appointment",t),this.viewDetails.emit(t)}closeViewDialog(){this.viewDialogOpen=!1,this.viewDialogItem={}}onDownloadReceipt(t){let e=t.turnId;if(!e){this.notificationService.error("No se encontr\xF3 el identificador del turno."),this.logger.error("Missing turnId for appointment",t);return}this.downloadingTurnIds.has(e)||(this.downloadingTurnIds.add(e),this.notificationService.info("Generando comprobante..."),this.turnDocumentsService.downloadMyTurnPdf(e).pipe(u(this.destroy$),P(()=>this.downloadingTurnIds.delete(e))).subscribe({next:s=>{let l=this.buildReceiptFilename(t);K(s,l),this.notificationService.success("Comprobante descargado correctamente"),this.downloadReceipt.emit(t)},error:s=>{this.notificationService.error("No se pudo descargar el comprobante. Intenta nuevamente."),this.logger.error("Error downloading turn receipt",{turnId:e,err:s})}}))}isDownloading(t){return this.downloadingTurnIds.has(t)}buildReceiptFilename(t){let e=new Date(t.date).toISOString().split("T")[0];return`turno-${t.specialty.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")||"hospital"}-${e}.pdf`}trackById(t,e){return e.id}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=S({type:n,selectors:[["app-history"]],inputs:{appointments:"appointments",loading:"loading"},outputs:{viewDetails:"viewDetails",downloadReceipt:"downloadReceipt"},decls:4,vars:2,consts:[["downloadIcon",""],[3,"message"],[3,"isOpen","title","item","columns"],[1,"error-state"],[1,"table-container"],[1,"table"],[1,"table__date"],[1,"table__date-day"],[1,"table__date-time"],[1,"status-badge",3,"ngClass"],[1,"status-badge__dot"],[1,"table__actions"],["type","button","title","Ver detalles",1,"btn-icon",3,"click"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 0 24 24","fill","none","stroke","currentColor",1,"icon"],["stroke-linecap","round","stroke-linejoin","round","d","M15 12a3 3 0 11-6 0 3 3 0 016 0z"],["stroke-linecap","round","stroke-linejoin","round","d","M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"],["type","button","title","Descargar comprobante",1,"btn-icon",3,"click","disabled"],[4,"ngIf","ngIfElse"],["aria-hidden","true",1,"spinner"],["stroke-linecap","round","stroke-linejoin","round","d","M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"],["colspan","5"],[1,"empty-state"],[1,"empty-state__icon"],["stroke-linecap","round","stroke-linejoin","round","d","M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"],[3,"close","isOpen","title","item","columns"]],template:function(e,s){e&1&&(o(0,"section"),b(1,X,1,1,"app-loading-spinner",1)(2,re,2,1)(3,ie,1,4,"app-view-dialog",2),r()),e&2&&(a(),h(s.localLoading?1:2),a(2),h(s.viewDialogOpen?3:-1))},dependencies:[j,L,$,G,q],styles:["[_ngcontent-%COMP%]:root{--user-panel-surface: var(--surface-primary);--user-panel-surface-alt: color-mix(in srgb, var(--surface-primary) 92%, var(--surface-secondary) 8%);--user-panel-surface-muted: color-mix(in srgb, var(--surface-primary) 85%, var(--surface-secondary) 15%);--user-panel-border: var(--border-subtle);--user-panel-border-strong: var(--border-strong);--user-panel-text: var(--text-primary);--user-panel-text-muted: var(--text-secondary);--user-panel-text-soft: var(--text-muted);--user-panel-primary: var(--color-primary);--user-panel-primary-hover: var(--color-primary-hover);--user-panel-primary-dark: var(--color-primary-dark);--user-panel-primary-soft: color-mix(in srgb, var(--color-primary) 12%, transparent 88%);--user-panel-layer-soft: color-mix(in srgb, var(--color-primary) 10%, transparent 90%);--user-panel-layer-strong: color-mix(in srgb, var(--color-primary) 18%, transparent 82%);--user-panel-success: var(--color-success);--user-panel-success-soft: color-mix(in srgb, var(--color-success) 16%, transparent 84%);--user-panel-warning: var(--color-warning);--user-panel-warning-soft: color-mix(in srgb, var(--color-warning) 16%, transparent 84%);--user-panel-danger: var(--color-error);--user-panel-danger-soft: color-mix(in srgb, var(--color-error) 16%, transparent 84%);--user-panel-info: var(--color-info);--user-panel-info-soft: color-mix(in srgb, var(--color-info) 16%, transparent 84%);--user-panel-shadow-sm: var(--shadow-sm);--user-panel-shadow-md: var(--shadow-md);--user-panel-shadow-lg: var(--shadow-lg);--user-panel-focus-ring: var(--focus-ring);--user-panel-overlay: var(--surface-backdrop);--user-panel-navbar-hover: color-mix(in srgb, var(--color-primary) 12%, transparent 88%);--user-panel-navbar-active: color-mix(in srgb, var(--color-primary) 18%, transparent 82%);--user-panel-navbar-border: color-mix(in srgb, var(--color-primary) 25%, transparent 75%);--user-panel-navbar-gradient: var(--gradient-primary);--user-panel-navbar-text: var(--text-primary);--user-panel-footer-shadow: var(--shadow-sm);--user-panel-footer-button-shadow: color-mix(in srgb, var(--color-primary) 20%, transparent 80%)}[data-theme=dark][_ngcontent-%COMP%]{--user-panel-surface-alt: color-mix(in srgb, var(--surface-primary) 88%, var(--surface-secondary) 12%);--user-panel-surface-muted: color-mix(in srgb, var(--surface-primary) 70%, var(--surface-secondary) 30%);--user-panel-navbar-hover: color-mix(in srgb, var(--color-primary) 20%, transparent 80%);--user-panel-navbar-active: color-mix(in srgb, var(--color-primary) 28%, transparent 72%);--user-panel-footer-shadow: var(--shadow-md)}.icon[_ngcontent-%COMP%]{width:20px;height:20px;stroke-width:2}.btn[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:var(--border-radius-sm);font-weight:500;font-size:14px;cursor:pointer;transition:var(--transition-smooth);border:none;color:var(--text-white)}.btn--primary[_ngcontent-%COMP%]{color:var(--text-white);background:linear-gradient(135deg,var(--user-panel-primary) 0%,var(--user-panel-primary-dark) 100%)}.btn--outline[_ngcontent-%COMP%]{background-color:transparent;color:var(--user-panel-text);border:1px solid var(--user-panel-border)}.btn--outline[_ngcontent-%COMP%]:hover{background-color:var(--user-panel-surface)}.btn--danger[_ngcontent-%COMP%]{background-color:var(--user-panel-danger);color:var(--text-white)}.btn--danger[_ngcontent-%COMP%]:hover{background-color:color-mix(in srgb,var(--user-panel-danger) 95%,black 5%)}.btn--sm[_ngcontent-%COMP%]{padding:6px 12px;font-size:12px}.btn[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{width:16px;height:16px}.btn-icon[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:50%;background-color:transparent;color:var(--user-panel-text-muted);border:none;cursor:pointer;transition:var(--transition-smooth)}.btn-icon[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:flex-start;gap:8px}.btn-icon[_ngcontent-%COMP%]:hover{background-color:var(--user-panel-surface);color:var(--user-panel-primary)}.btn-icon[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{width:18px;height:18px}.empty-state[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;flex-direction:column;padding:60px 20px;text-align:center}.empty-state__icon[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:80px;height:80px;border-radius:50%;background-color:var(--user-panel-layer-soft);color:var(--user-panel-primary);margin-bottom:24px}.empty-state__icon[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{width:40px;height:40px}.empty-state[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:20px;font-weight:600;margin:0 0 8px;color:var(--user-panel-text)}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;color:var(--user-panel-text-muted);margin:0 0 24px}.table-container[_ngcontent-%COMP%]{margin-top:32px;overflow-x:auto;border-radius:var(--border-radius-md);box-shadow:var(--user-panel-shadow-sm)}@media (max-width: 479px){.table-container[_ngcontent-%COMP%]{margin:0 -16px;border-radius:0}}.table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;background-color:var(--user-panel-surface-alt);min-width:600px}.table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:16px;text-align:left}@media (max-width: 479px){.table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:12px 8px}}@media (min-width: 480px) and (max-width: 767px){.table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:14px 12px}}.table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:var(--user-panel-surface);color:var(--user-panel-text-muted);font-weight:500;font-size:14px;border-bottom:1px solid var(--user-panel-border);position:sticky;top:0;z-index:1}@media (max-width: 479px){.table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{font-size:12px}}.table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border-bottom:1px solid var(--user-panel-border);color:var(--user-panel-text);font-size:14px}@media (max-width: 479px){.table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{font-size:13px}}.table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:last-child   td[_ngcontent-%COMP%]{border-bottom:none}.table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:hover   td[_ngcontent-%COMP%]{background-color:var(--user-panel-surface)}@media (hover: none) and (pointer: coarse){.table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:hover   td[_ngcontent-%COMP%]{background-color:transparent}}.table__date[_ngcontent-%COMP%]{display:flex;flex-direction:column}.table__date-day[_ngcontent-%COMP%]{font-weight:500;color:var(--user-panel-text)}@media (max-width: 479px){.table__date-day[_ngcontent-%COMP%]{font-size:13px}}.table__date-time[_ngcontent-%COMP%]{font-size:12px;color:var(--user-panel-text-muted);margin-top:4px}@media (max-width: 479px){.table__date-time[_ngcontent-%COMP%]{font-size:11px}}.table__actions[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:flex-start;gap:8px}@media (max-width: 479px){.table__actions[_ngcontent-%COMP%]{flex-direction:column;gap:4px}}.status-badge[_ngcontent-%COMP%]{padding:4px 10px;border-radius:9999px;font-size:12px;font-weight:500;background-color:color-mix(in srgb,var(--color-secondary) 10%,transparent 90%);color:var(--color-secondary);white-space:nowrap}.status-badge[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:6px}.status-badge__dot[_ngcontent-%COMP%]{width:8px;height:8px;border-radius:50%;background-color:var(--color-secondary);flex-shrink:0}.status-badge--completed[_ngcontent-%COMP%]{background-color:color-mix(in srgb,var(--user-panel-success) 10%,transparent 90%);color:var(--user-panel-success)}.status-badge--completed[_ngcontent-%COMP%]   .status-badge__dot[_ngcontent-%COMP%]{background-color:var(--user-panel-success)}.status-badge--cancelled[_ngcontent-%COMP%]{background-color:color-mix(in srgb,var(--user-panel-danger) 10%,transparent 90%);color:var(--user-panel-danger)}.status-badge--cancelled[_ngcontent-%COMP%]   .status-badge__dot[_ngcontent-%COMP%]{background-color:var(--user-panel-danger)}@media (max-width: 479px){.status-badge[_ngcontent-%COMP%]{font-size:11px;padding:3px 8px}.status-badge__dot[_ngcontent-%COMP%]{width:6px;height:6px}}.loading-spinner[_ngcontent-%COMP%]{text-align:center;padding:2rem;color:var(--user-panel-text)}.loading-spinner[_ngcontent-%COMP%]{display:flex;flex-direction:column}.loading-spinner[_ngcontent-%COMP%]   .loading-icon[_ngcontent-%COMP%]{font-size:2rem;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin-bottom:.5rem}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.btn-icon[_ngcontent-%COMP%]{border:none;background:transparent;color:var(--user-panel-text-muted);padding:8px;border-radius:var(--border-radius-sm);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:var(--transition-smooth)}.btn-icon[_ngcontent-%COMP%]:hover:not(:disabled){color:var(--user-panel-primary);background-color:color-mix(in srgb,var(--user-panel-primary) 12%,transparent 88%)}.btn-icon[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.spinner[_ngcontent-%COMP%]{width:16px;height:16px;border:2px solid currentColor;border-top-color:transparent;border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite}"]})};export{Q as HistoryComponent};
