import{a as q,b as W}from"./chunk-GNK2JWS7.js";import{a as B}from"./chunk-RBRDWJHI.js";import{a as R}from"./chunk-AEATOIBS.js";import"./chunk-VO6ML35U.js";import"./chunk-QMYIRM4F.js";import"./chunk-2WAWTWTY.js";import"./chunk-RYO32FGU.js";import{a as H}from"./chunk-BR3QFQIC.js";import"./chunk-GK5PG2NL.js";import"./chunk-R25INWIT.js";import"./chunk-HDR7MDZE.js";import"./chunk-O57RU464.js";import{a as z}from"./chunk-YOZKJIIB.js";import{b as I,d as V}from"./chunk-RTO3QJN4.js";import"./chunk-NSPTTQBB.js";import"./chunk-ZGRDZCQA.js";import{e as w,g as N,j,m as U,t as G,v as $}from"./chunk-SZQKAXFT.js";import{Ca as F,Cb as _,Hb as a,Ib as s,Jb as O,Mb as P,Ob as S,Pb as g,S as v,Uc as E,Zb as l,_a as d,aa as p,ac as A,f as D,ia as y,ja as M,kb as k,pb as h,uc as L,wb as f}from"./chunk-MFDETKI4.js";import"./chunk-4CLCTAJ7.js";function Z(n,e){n&1&&(a(0,"div",1)(1,"i",2),l(2,"hourglass_empty"),s(),a(3,"span"),l(4,"Cargando datos del turno..."),s()())}function tt(n,e){if(n&1&&O(0,"app-time-selection",8),n&2){let t=g(3);f("timeControl",t.timeControl)("availableTimeSlots",t.availableTimeSlots)("isLoading",t.isLoading)("error",t.error)}}function et(n,e){if(n&1){let t=P();a(0,"h2",4),l(1,"Reprogramar turno"),s(),a(2,"p",5),l(3),s(),a(4,"form",6),O(5,"app-date-selection",7),h(6,tt,1,4,"app-time-selection",8),a(7,"div",9)(8,"button",10),S("click",function(){y(t);let r=g(2);return M(r.router.navigate(["/user-panel"]))}),l(9,"Cancelar"),s(),a(10,"button",11),l(11,"Confirmar reprogramaci\xF3n"),s()()()}if(n&2){let t=g(2);d(3),A("Est\xE1s reprogramando un turno para ",t.appointment.specialty," con ",t.appointment.doctorName,""),d(),f("formGroup",t.appointmentForm),d(),f("dateControl",t.dateControl)("minDate",t.minDate)("dayFilter",t.dayFilter)("isLoading",t.isLoading)("error",t.error),d(),_(t.availableTimeSlots.length>0?6:-1),d(4),f("disabled",t.appointmentForm.invalid)}}function nt(n,e){if(n&1){let t=P();a(0,"div",3)(1,"h2"),l(2,"Error"),s(),a(3,"p"),l(4,"No se pudo cargar el turno. Por favor, intenta de nuevo."),s(),a(5,"button",12),S("click",function(){y(t);let r=g(2);return M(r.router.navigate(["/user-panel"]))}),l(6,"Volver al panel"),s()()}}function ot(n,e){if(n&1&&h(0,et,12,10)(1,nt,7,0,"div",3),n&2){let t=g();_(t.appointment?0:1)}}var Y=class n{fb=p(G);appointmentService=p(B);scheduleService=p(R);logger=p(z);notificationService=p(H);route=p(I);router=p(V);cdr=p(L);platformId=p(F);appointmentForm;appointment=null;availableDays=[];availableTimeSlots=[];schedules=[];isLoading=!0;error=null;minDate=new Date;destroy$=new D;ngOnInit(){this.initForm(),this.loadAppointment(),this.watchFormChanges()}initForm(){this.appointmentForm=this.fb.group({appointmentDate:[null,w.required],appointmentTime:[null,w.required]})}watchFormChanges(){this.appointmentForm.get("appointmentDate")?.valueChanges.subscribe(e=>{e?this.generateTimeSlots(e):(this.availableTimeSlots=[],this.appointmentForm.get("appointmentTime")?.setValue(null)),this.cdr.detectChanges()})}loadAppointment(){let e=this.route.snapshot.paramMap.get("id");if(!e){this.notificationService.error("No se proporcion\xF3 un ID de turno"),this.router.navigate(["/user-panel"]);return}this.appointmentService.getTurnById(e).pipe(v(this.destroy$)).subscribe({next:t=>{this.appointment=this.mapTurnToAppointment(t),t.service?.[0]?.specialty_id?this.loadAvailableDays(t.service[0].specialty_id):(this.error="No se encontr\xF3 la especialidad para este turno",this.isLoading=!1,this.router.navigate(["/user-panel"]))},error:t=>{this.logger.error("Error al cargar el turno",t),this.notificationService.error("Error al cargar los datos del turno"),this.isLoading=!1,this.router.navigate(["/user-panel"])}})}mapTurnToAppointment(e){return{id:e.appointment_id??e.id,turnId:e.id,date:e.date,time:e.time.split(":").slice(0,2).join(":"),specialty:e.service?.[0]?.name??"Sin especialidad",doctorName:e.doctor?`${e.doctor.first_name} ${e.doctor.last_name}`.trim():"Sin m\xE9dico asignado",state:e.state}}loadAvailableDays(e){let i=Date.now();this.scheduleService.getAvailableDays(e).pipe(v(this.destroy$)).subscribe({next:r=>{this.schedules=r.available_days.map(o=>({day:o.day,start_time:o.start_time,end_time:o.end_time})),this.availableDays=[...new Set(this.schedules.map(o=>o.day))];let m=500-(Date.now()-i);setTimeout(()=>{this.isLoading=!1,this.cdr.detectChanges()},m>0?m:0)},error:r=>{let m=500-(Date.now()-i);setTimeout(()=>{this.isLoading=!1,this.error="Error al cargar los d\xEDas disponibles",this.notificationService.error(this.error),this.router.navigate(["/user-panel"])},m>0?m:0)}})}generateTimeSlots(e){let t=e.toLocaleDateString("es-ES",{weekday:"long"}).toLowerCase(),r={lunes:"monday",martes:"tuesday",mi\u00E9rcoles:"wednesday",jueves:"thursday",viernes:"friday",s\u00E1bado:"saturday",domingo:"sunday"}[t]||"",c=this.schedules.filter(o=>o.day.toLowerCase()===r.toLowerCase());if(!c.length){this.availableTimeSlots=[],this.appointmentForm.get("appointmentTime")?.setValue(null);return}let m=c.flatMap(o=>this.generateTimeIntervals(o.start_time,o.end_time));this.availableTimeSlots=[...new Set(m)].sort((o,C)=>o.localeCompare(C)),this.appointmentForm.get("appointmentTime")?.setValue(null)}generateTimeIntervals(e,t,i=30){let r=[],[c,m]=e.split(":").slice(0,2).map(Number),[o,C]=t.split(":").slice(0,2).map(Number),b=new Date;b.setHours(c,m,0,0);let T=new Date;T.setHours(o,C,0,0);let J=new Date,K=this.isSameDay(this.appointmentForm.get("appointmentDate")?.value,J),u=b;if(K){let x=new Date;if(x>b){let Q=x.getMinutes(),X=Math.ceil((Q+1)/i)*i;u.setHours(x.getHours(),X,0,0)}}for(;u<T;)r.push(this.formatTime(u)),u=new Date(u.getTime()+i*60*1e3);return r}isSameDay(e,t){return e?e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear():!1}formatTime(e){return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:00`}dayFilter=e=>{if(!e)return!1;let t=new Date;if(t.setHours(0,0,0,0),e<t||!this.availableDays.length)return!1;let i={lunes:"monday",martes:"tuesday",mi\u00E9rcoles:"wednesday",jueves:"thursday",viernes:"friday",s\u00E1bado:"saturday",domingo:"sunday"},r=e.toLocaleDateString("es-ES",{weekday:"long"}).toLowerCase(),c=i[r]||"";return this.availableDays.includes(c)};formatDateISO(e){return e.toISOString().split("T")[0]}markFormGroupTouched(e){Object.values(e.controls).forEach(t=>{t.markAsTouched(),t.controls&&this.markFormGroupTouched(t)})}get dateControl(){return this.appointmentForm.get("appointmentDate")}get timeControl(){return this.appointmentForm.get("appointmentTime")}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=k({type:n,selectors:[["app-update-appointment"]],decls:3,vars:1,consts:[[1,"update-appointment"],[1,"loading-spinner"],[1,"material-icons","loading-icon"],[1,"error-state"],[1,"page-title"],[1,"page-subtitle"],[3,"formGroup"],[3,"dateControl","minDate","dayFilter","isLoading","error"],[3,"timeControl","availableTimeSlots","isLoading","error"],[1,"form-actions"],["type","button",1,"btn","btn--outline",3,"click"],["type","submit",1,"btn","btn--primary",3,"disabled"],[1,"btn","btn--primary",3,"click"]],template:function(t,i){t&1&&(a(0,"div",0),h(1,Z,5,0,"div",1)(2,ot,2,1),s()),t&2&&(d(),_(i.isLoading?1:2))},dependencies:[E,$,j,N,U,q,W],styles:[".icon[_ngcontent-%COMP%]{width:20px;height:20px;stroke-width:2}.btn[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:6px;font-weight:500;font-size:14px;cursor:pointer;transition:all .2s ease;border:none;color:#fff}.btn--primary[_ngcontent-%COMP%]{color:#fff;background:linear-gradient(135deg,#3b82f6,#1d4ed8)}.btn--outline[_ngcontent-%COMP%]{background-color:transparent;color:#1f2937;border:1px solid #e5e7eb}.btn--outline[_ngcontent-%COMP%]:hover{background-color:#f9fafb}.btn--danger[_ngcontent-%COMP%]{background-color:#ef4444;color:#fff}.btn--danger[_ngcontent-%COMP%]:hover{background-color:#ed2d2d}.btn--sm[_ngcontent-%COMP%]{padding:6px 12px;font-size:12px}.btn[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{width:16px;height:16px}.btn-icon[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:50%;background-color:transparent;color:#6b7280;border:none;cursor:pointer;transition:all .2s ease}.btn-icon[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:flex-start;gap:8px}.btn-icon[_ngcontent-%COMP%]:hover{background-color:#f9fafb;color:#3b82f6}.btn-icon[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{width:18px;height:18px}.empty-state[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;flex-direction:column;padding:60px 20px;text-align:center}.empty-state__icon[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:80px;height:80px;border-radius:50%;background-color:#3b82f61a;color:#3b82f6;margin-bottom:24px}.empty-state__icon[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{width:40px;height:40px}.empty-state[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:20px;font-weight:600;margin:0 0 8px;color:#1f2937}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;color:#6b7280;margin:0 0 24px}.update-appointment[_ngcontent-%COMP%]{padding:20px;max-width:600px;margin:0 auto}@media (max-width: 479px){.update-appointment[_ngcontent-%COMP%]{padding:16px}}.page-title[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:600;color:#1f2937;text-align:center;margin-bottom:.5rem}@media (max-width: 479px){.page-title[_ngcontent-%COMP%]{font-size:1.5rem}}.page-subtitle[_ngcontent-%COMP%]{font-size:1rem;color:#6b7280;text-align:center;margin-bottom:2rem}@media (max-width: 479px){.page-subtitle[_ngcontent-%COMP%]{font-size:.9rem}}.form-actions[_ngcontent-%COMP%]{margin-top:1.5rem}.form-actions[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:flex-end;gap:12px}@media (max-width: 479px){.form-actions[_ngcontent-%COMP%]{flex-direction:column;gap:8px}}.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{padding:10px 16px;font-size:.9rem;border-radius:6px}@media (max-width: 479px){.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:100%}}.form-actions[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]{background-color:#3b82f6;color:#fff;border:none}.form-actions[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]:hover{background-color:#2563eb}.form-actions[_ngcontent-%COMP%]   .btn--primary[disabled][_ngcontent-%COMP%]{background-color:#9ca3af;cursor:not-allowed}.form-actions[_ngcontent-%COMP%]   .btn--outline[_ngcontent-%COMP%]{color:#3b82f6;border:1px solid #3b82f6;background:transparent}.form-actions[_ngcontent-%COMP%]   .btn--outline[_ngcontent-%COMP%]:hover{background-color:#3b82f61a}.loading-spinner[_ngcontent-%COMP%]{text-align:center;padding:2rem;color:#6b7280}.loading-spinner[_ngcontent-%COMP%]{display:flex;flex-direction:column}.loading-spinner[_ngcontent-%COMP%]   .loading-icon[_ngcontent-%COMP%]{font-size:2rem;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin-bottom:.5rem}.error-state[_ngcontent-%COMP%]{padding:60px 20px;text-align:center;background-color:#f9fafb;border-radius:8px;box-shadow:0 1px 3px #0000001a;display:flex;align-items:center;justify-content:center}.error-state[_ngcontent-%COMP%]{display:flex;flex-direction:column}@media (max-width: 479px){.error-state[_ngcontent-%COMP%]{padding:40px 16px}}.error-state[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:20px;font-weight:600;margin:0 0 8px;color:#1f2937}@media (max-width: 479px){.error-state[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:18px}}.error-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;color:#6b7280;margin:0 0 24px}@media (max-width: 479px){.error-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:13px;margin-bottom:16px}}.error-state[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]{background-color:#3b82f6;color:#fff}.error-state[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]:hover{background-color:#2563eb}@media (max-width: 479px){.error-state[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]{width:100%}}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}"]})};export{Y as UpdateAppointmentComponent};
