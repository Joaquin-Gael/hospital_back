import{a as b}from"./chunk-4W6XZAEZ.js";import{a as v,b as m,d as k}from"./chunk-3F3ZFDNX.js";import{a as l}from"./chunk-SHF7GFMJ.js";import{C as s,Ec as u,R as p,T as d,W as f,aa as c,l as i,m as S,q as g,za as h}from"./chunk-U346BHW4.js";var o={LOGIN:"auth/login",OAUTH_LOGIN:n=>`/oauth/${n}/`,DOC_LOGIN:"auth/doc/login",DECODE:"/auth/decode/",REFRESH:"auth/refresh",LOGOUT:"auth/logout",SCOPES:"auth/scopes",ME:"users/me"};var O=class n{apiService=c(k);storage=c(b);logger=c(v);apiBaseUrl=c(m);loginStatusSignal=h(!1);loginStatus$=u(()=>this.loginStatusSignal());scopesSignal=h(this.loadScopesFromStorage());scopes$=u(()=>this.scopesSignal());loadScopesFromStorage(){let e=this.storage.getItem("scopes");return e?JSON.parse(e):[]}setLoggedIn(e){this.loginStatusSignal.set(e)}isLoggedIn(){return this.loginStatusSignal()}readCookie(e){let t=`; ${document.cookie||""}`.split(`; ${e}=`);return t.length===2&&t.pop()?.split(";").shift()||null}getCsrfTokenFromCookies(){let e=["csrf_token","csrftoken","csrf"];for(let r of e){let t=this.readCookie(r);if(t)return t}return null}getHeadersForSensitive(e=!1){if(!e)return new l;let r=this.getCsrfTokenFromCookies();return r?new l().set("X-CSRF-Token",r):new l}getAccessTokenFromCookie(){let e=["access_token","accessToken","access"];for(let r of e){let t=this.readCookie(r);if(t)return t}return""}login(e){let r=new FormData;return r.append("email",e.email),r.append("password",e.password),this.apiService.post(o.LOGIN,r,{withCredentials:!0}).pipe(p(t=>(this.setLoggedIn(!0),this.hydrateScopes(t))),s(t=>this.handleError("User Login",t)))}oauthLogin(e){let r=`${this.apiBaseUrl}${o.OAUTH_LOGIN(e)}`;this.logger.debug(`Redirigiendo a OAuth para ${e}: ${r}`),window.location.href=r}exchangeCodeForToken(e){let r=`${this.apiBaseUrl}/api/oauth/google`;return this.logger.debug(`Intercambiando c\xF3digo en: ${r}`),this.apiService.post(r,{code:e},{withCredentials:!0}).pipe(p(t=>(this.logger.debug("Token recibido:",t.access_token),this.setLoggedIn(!0),this.hydrateScopes(t))),s(t=>this.handleError("OAuth Code Exchange",t)))}decode(e){return this.logger.debug("Decodificando c\xF3digo secreto"),this.apiService.post(o.DECODE,{code:e},{withCredentials:!0}).pipe(p(r=>(this.logger.debug("Access token recibido:",r.access_token),this.setLoggedIn(!0),this.hydrateScopes(r))),s(r=>this.handleError("Decode Code",r)))}storeAccessToken(e){return this.logger.debug("storeAccessToken llamado en modo cookies, token ignorado.",e),this.setLoggedIn(!0),i(void 0)}doctorLogin(e){let r=new FormData;return r.append("email",e.email),r.append("password",e.password),this.apiService.post(o.DOC_LOGIN,r,{withCredentials:!0}).pipe(p(t=>(this.setLoggedIn(!0),this.hydrateScopes(t))),s(t=>this.handleError("Doctor Login",t)))}getUser(){return this.isLoggedIn()?this.apiService.get(o.ME,{withCredentials:!0}).pipe(g(e=>e?.user??null),s(()=>i(null))):i(null)}logout(){return this.isLoggedIn()?this.apiService.delete(o.LOGOUT,{withCredentials:!0,headers:this.getHeadersForSensitive(!0)}).pipe(d(()=>{this.clearSession()}),s(e=>(this.logger.warn("Logout request failed",e),this.clearSession(),i(void 0)))):(this.clearSession(),i(void 0))}refreshToken(){return this.apiService.get(o.REFRESH,{withCredentials:!0,headers:this.getHeadersForSensitive(!0)}).pipe(d(()=>{this.setLoggedIn(!0)}),s(e=>(this.setLoggedIn(!1),this.clearSession(),this.handleError("Refresh token",e))))}getScopes(){return this.apiService.get(o.SCOPES,{withCredentials:!0}).pipe(g(e=>e.scopes),s(()=>i([])))}setScopes(e){let r=e||[];this.scopesSignal.set(r),this.storage.setItem("scopes",JSON.stringify(r))}getStoredScopes(){return this.scopesSignal()}hydrateScopes(e){return this.apiService.get(o.SCOPES,{withCredentials:!0}).pipe(d({next:r=>{this.setScopes(r.scopes)},error:()=>{this.setScopes([])}}),g(()=>e),s(()=>(this.setScopes([]),i(e))))}clearSession(){this.storage.clearStorage&&this.storage.clearStorage(),this.setLoggedIn(!1),this.setScopes([])}extractErrorDetail(e){if(typeof e=="string")return e;if(e&&typeof e=="object"){if("detail"in e&&typeof e.detail=="string")return e.detail;if("message"in e&&typeof e.message=="string")return e.message}}handleError(e,r){this.logger.error(`${e} failed`,r);let t=this.extractErrorDetail(r.error),a="Ocurri\xF3 un error inesperado";switch(r.status){case 400:a=t??"Datos de solicitud inv\xE1lidos";break;case 401:case 403:a=t??"Credenciales inv\xE1lidas",this.clearSession();break;case 404:a=t??"Recurso no encontrado";break;default:a=t??"Error del servidor";break}return S(()=>new Error(a))}static \u0275fac=function(r){return new(r||n)};static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})};export{O as a};
