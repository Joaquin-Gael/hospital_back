import{a as k}from"./chunk-R25INWIT.js";import{a as b,b as f}from"./chunk-YOZKJIIB.js";import{a as u}from"./chunk-ZGRDZCQA.js";import{B as r,R as p,T as c,W as S,aa as h,g as d,l as n,m as l,p as a}from"./chunk-MFDETKI4.js";var o={LOGIN:"auth/login",OAUTH_LOGIN:g=>`/oauth/${g}/`,DOC_LOGIN:"auth/doc/login",DECODE:"/auth/decode/",REFRESH:"auth/refresh",LOGOUT:"auth/logout",SCOPES:"auth/scopes",ME:"users/me"};var m=class g{apiService=h(f);storage=h(k);logger=h(b);loginStatusSubject=new d(this.isLoggedIn());loginStatus$=this.loginStatusSubject.asObservable();isLoggedIn(){return!!this.storage.getAccessToken()}login(s){let t=new u().set("email",s.email).set("password",s.password);return this.apiService.post(o.LOGIN,t.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).pipe(p(e=>(this.storage.setAccessToken(e.access_token),this.storage.setRefreshToken(e.refresh_token),this.loginStatusSubject.next(!0),this.apiService.get(o.SCOPES).pipe(c(i=>{this.setScopes(i.scopes)}),a(()=>e),r(()=>(this.setScopes([]),n(e)))))),r(e=>this.handleError("User Login",e)))}oauthLogin(s){let t=`http://127.0.0.1:8000${o.OAUTH_LOGIN(s)}`;this.logger.debug(`Redirigiendo a OAuth para ${s}: ${t}`),window.location.href=t}exchangeCodeForToken(s){let t="http://127.0.0.1:8000/api/oauth/google";return this.logger.debug(`Intercambiando c\xF3digo en: ${t}`),this.apiService.post(t,{code:s}).pipe(p(e=>(this.logger.debug("Token recibido:",e.access_token),this.storage.setAccessToken(e.access_token),e.refresh_token&&this.storage.setRefreshToken(e.refresh_token),this.loginStatusSubject.next(!0),this.apiService.get(o.SCOPES).pipe(c(i=>{this.setScopes(i.scopes)}),a(()=>e),r(()=>(this.setScopes([]),n(e)))))),r(e=>this.handleError("OAuth Code Exchange",e)))}decode(s){return this.logger.debug("Decodificando c\xF3digo secreto"),this.apiService.post(o.DECODE,{code:s}).pipe(p(t=>(this.logger.debug("Access token recibido:",t.access_token),this.storage.setAccessToken(t.access_token),this.loginStatusSubject.next(!0),this.apiService.get(o.SCOPES).pipe(c(e=>{this.setScopes(e.scopes)}),a(()=>t),r(()=>(this.setScopes([]),n(t)))))),r(t=>this.handleError("Decode Code",t)))}storeAccessToken(s){this.logger.debug("Almacenando access_token:",s),this.storage.setAccessToken(s);let t=this.storage.getAccessToken();return t?(this.logger.debug("Token almacenado correctamente:",t),this.loginStatusSubject.next(!0),n(void 0)):(this.logger.error("No se pudo almacenar el access_token"),l(()=>new Error("No se pudo almacenar el access_token")))}doctorLogin(s){let t=new u().set("email",s.email).set("password",s.password);return this.apiService.post(o.DOC_LOGIN,t.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).pipe(p(e=>(this.storage.setAccessToken(e.access_token),this.storage.setRefreshToken(e.refresh_token),this.loginStatusSubject.next(!0),this.apiService.get(o.SCOPES).pipe(c(i=>{this.setScopes(i.scopes)}),a(()=>e),r(()=>(this.setScopes([]),n(e)))))),r(e=>this.handleError("Doctor Login",e)))}getUser(){return this.isLoggedIn()?this.apiService.get(o.ME).pipe(a(s=>s?.user??null),r(()=>n(null))):n(null)}logout(){return this.isLoggedIn()?this.apiService.delete(o.LOGOUT).pipe(c(()=>{this.storage.clearStorage(),this.loginStatusSubject.next(!1)}),r(()=>(this.storage.clearStorage(),this.loginStatusSubject.next(!1),n(void 0)))):(this.storage.clearStorage(),this.loginStatusSubject.next(!1),n(void 0))}refreshToken(){let s=this.storage.getRefreshToken();s||(this.storage.clearStorage(),this.loginStatusSubject.next(!1),this.logger.error("No refresh token available "));let t={headers:{Authorization:`Bearer ${s}`}};return this.apiService.get(o.REFRESH,t).pipe(c(e=>{this.storage.setAccessToken(e.access_token),this.storage.setRefreshToken(e.refresh_token),this.loginStatusSubject.next(!0)}),r(e=>this.handleError("Refresh token",e)))}getScopes(){return this.apiService.get(o.SCOPES).pipe(a(s=>s.scopes),r(()=>n([])))}setScopes(s){this.storage.setItem("scopes",JSON.stringify(s))}getStoredScopes(){let s=this.storage.getItem("scopes");return s?JSON.parse(s):[]}handleError(s,t){this.logger.error(`${s} failed`,t);let e="Ocurri\xF3 un error inesperado";if(t instanceof Error)e=t.message;else if(typeof t=="object"&&t!==null&&"status"in t){let i=t;switch(i.status){case 400:e=i.error?.detail??"Datos de solicitud inv\xE1lidos";break;case 401:case 404:e=i.error?.detail??"Credenciales inv\xE1lidas",this.storage.clearStorage(),this.loginStatusSubject.next(!1);break;case 403:e=i.error?.detail??"Acci\xF3n no permitida";break;default:e=i.error?.detail??"Error del servidor"}}return l(()=>new Error(e))}static \u0275fac=function(t){return new(t||g)};static \u0275prov=S({token:g,factory:g.\u0275fac,providedIn:"root"})};export{m as a};
