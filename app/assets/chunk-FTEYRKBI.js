import{a as q,b as W}from"./chunk-XPH5QEDN.js";import{a as B}from"./chunk-HP6QVOZ5.js";import{a as R}from"./chunk-UJLVOMAY.js";import"./chunk-VO6ML35U.js";import"./chunk-QMYIRM4F.js";import"./chunk-6JBQLTUK.js";import"./chunk-RYO32FGU.js";import{a as H}from"./chunk-2DW5HR5M.js";import"./chunk-D7I6PEHK.js";import"./chunk-PC5HHMPZ.js";import"./chunk-LILA3PAH.js";import"./chunk-TYX6CIEY.js";import{a as z}from"./chunk-J2GLTX2R.js";import{b as I,d as V}from"./chunk-RASRAAIY.js";import"./chunk-JUPDXIAV.js";import"./chunk-GGYCCLGV.js";import{e as S,g as N,k as j,n as U,u as G,w as $}from"./chunk-VEGP4YTZ.js";import{$b as l,Ca as k,Eb as h,Jb as i,Kb as s,Lb as O,Ob as w,Qb as P,Rb as u,S as _,Yc as E,_a as d,aa as p,cc as A,f as D,ia as C,ja as M,kb as F,pb as f,wc as L,yb as v}from"./chunk-VYPP3LKO.js";import"./chunk-4CLCTAJ7.js";function Z(n,t){n&1&&(i(0,"div",1)(1,"i",2),l(2,"hourglass_empty"),s(),i(3,"span"),l(4,"Cargando datos del turno..."),s()())}function ee(n,t){if(n&1&&O(0,"app-time-selection",8),n&2){let e=u(3);v("timeControl",e.timeControl)("availableTimeSlots",e.availableTimeSlots)("isLoading",e.isLoading)("error",e.error)}}function te(n,t){if(n&1){let e=w();i(0,"h2",4),l(1,"Reprogramar turno"),s(),i(2,"p",5),l(3),s(),i(4,"form",6),O(5,"app-date-selection",7),f(6,ee,1,4,"app-time-selection",8),i(7,"div",9)(8,"button",10),P("click",function(){C(e);let a=u(2);return M(a.router.navigate(["/user-panel"]))}),l(9,"Cancelar"),s(),i(10,"button",11),l(11,"Confirmar reprogramaci\xF3n"),s()()()}if(n&2){let e=u(2);d(3),A("Est\xE1s reprogramando un turno para ",e.appointment.specialty," con ",e.appointment.doctorName,""),d(),v("formGroup",e.appointmentForm),d(),v("dateControl",e.dateControl)("minDate",e.minDate)("dayFilter",e.dayFilter)("isLoading",e.isLoading)("error",e.error),d(),h(e.availableTimeSlots.length>0?6:-1),d(4),v("disabled",e.appointmentForm.invalid)}}function ne(n,t){if(n&1){let e=w();i(0,"div",3)(1,"h2"),l(2,"Error"),s(),i(3,"p"),l(4,"No se pudo cargar el turno. Por favor, intenta de nuevo."),s(),i(5,"button",12),P("click",function(){C(e);let a=u(2);return M(a.router.navigate(["/user-panel"]))}),l(6,"Volver al panel"),s()()}}function re(n,t){if(n&1&&f(0,te,12,10)(1,ne,7,0,"div",3),n&2){let e=u();h(e.appointment?0:1)}}var Y=class n{fb=p(G);appointmentService=p(B);scheduleService=p(R);logger=p(z);notificationService=p(H);route=p(I);router=p(V);cdr=p(L);platformId=p(k);appointmentForm;appointment=null;availableDays=[];availableTimeSlots=[];schedules=[];isLoading=!0;error=null;minDate=new Date;destroy$=new D;ngOnInit(){this.initForm(),this.loadAppointment(),this.watchFormChanges()}initForm(){this.appointmentForm=this.fb.group({appointmentDate:[null,S.required],appointmentTime:[null,S.required]})}watchFormChanges(){this.appointmentForm.get("appointmentDate")?.valueChanges.subscribe(t=>{t?this.generateTimeSlots(t):(this.availableTimeSlots=[],this.appointmentForm.get("appointmentTime")?.setValue(null)),this.cdr.detectChanges()})}loadAppointment(){let t=this.route.snapshot.paramMap.get("id");if(!t){this.notificationService.error("No se proporcion\xF3 un ID de turno"),this.router.navigate(["/user-panel"]);return}this.appointmentService.getTurnById(t).pipe(_(this.destroy$)).subscribe({next:e=>{this.appointment=this.mapTurnToAppointment(e),e.service?.[0]?.specialty_id?this.loadAvailableDays(e.service[0].specialty_id):(this.error="No se encontr\xF3 la especialidad para este turno",this.isLoading=!1,this.router.navigate(["/user-panel"]))},error:e=>{this.logger.error("Error al cargar el turno",e),this.notificationService.error("Error al cargar los datos del turno"),this.isLoading=!1,this.router.navigate(["/user-panel"])}})}mapTurnToAppointment(t){return{id:t.appointment_id??t.id,turnId:t.id,date:t.date,time:t.time.split(":").slice(0,2).join(":"),specialty:t.service?.[0]?.name??"Sin especialidad",doctorName:t.doctor?`${t.doctor.first_name} ${t.doctor.last_name}`.trim():"Sin m\xE9dico asignado",state:t.state}}loadAvailableDays(t){let o=Date.now();this.scheduleService.getAvailableDays(t).pipe(_(this.destroy$)).subscribe({next:a=>{this.schedules=a.available_days.map(r=>({day:r.day,start_time:r.start_time,end_time:r.end_time})),this.availableDays=[...new Set(this.schedules.map(r=>r.day))];let m=500-(Date.now()-o);setTimeout(()=>{this.isLoading=!1,this.cdr.detectChanges()},m>0?m:0)},error:a=>{let m=500-(Date.now()-o);setTimeout(()=>{this.isLoading=!1,this.error="Error al cargar los d\xEDas disponibles",this.notificationService.error(this.error),this.router.navigate(["/user-panel"])},m>0?m:0)}})}generateTimeSlots(t){let e=t.toLocaleDateString("es-ES",{weekday:"long"}).toLowerCase(),a={lunes:"monday",martes:"tuesday",mi\u00E9rcoles:"wednesday",jueves:"thursday",viernes:"friday",s\u00E1bado:"saturday",domingo:"sunday"}[e]||"",c=this.schedules.filter(r=>r.day.toLowerCase()===a.toLowerCase());if(!c.length){this.availableTimeSlots=[],this.appointmentForm.get("appointmentTime")?.setValue(null);return}let m=c.flatMap(r=>this.generateTimeIntervals(r.start_time,r.end_time));this.availableTimeSlots=[...new Set(m)].sort((r,x)=>r.localeCompare(x)),this.appointmentForm.get("appointmentTime")?.setValue(null)}generateTimeIntervals(t,e,o=30){let a=[],[c,m]=t.split(":").slice(0,2).map(Number),[r,x]=e.split(":").slice(0,2).map(Number),b=new Date;b.setHours(c,m,0,0);let T=new Date;T.setHours(r,x,0,0);let J=new Date,K=this.isSameDay(this.appointmentForm.get("appointmentDate")?.value,J),g=b;if(K){let y=new Date;if(y>b){let Q=y.getMinutes(),X=Math.ceil((Q+1)/o)*o;g.setHours(y.getHours(),X,0,0)}}for(;g<T;)a.push(this.formatTime(g)),g=new Date(g.getTime()+o*60*1e3);return a}isSameDay(t,e){return t?t.getDate()===e.getDate()&&t.getMonth()===e.getMonth()&&t.getFullYear()===e.getFullYear():!1}formatTime(t){return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:00`}dayFilter=t=>{if(!t)return!1;let e=new Date;if(e.setHours(0,0,0,0),t<e||!this.availableDays.length)return!1;let o={lunes:"monday",martes:"tuesday",mi\u00E9rcoles:"wednesday",jueves:"thursday",viernes:"friday",s\u00E1bado:"saturday",domingo:"sunday"},a=t.toLocaleDateString("es-ES",{weekday:"long"}).toLowerCase(),c=o[a]||"";return this.availableDays.includes(c)};formatDateISO(t){return t.toISOString().split("T")[0]}markFormGroupTouched(t){Object.values(t.controls).forEach(e=>{e.markAsTouched(),e.controls&&this.markFormGroupTouched(e)})}get dateControl(){return this.appointmentForm.get("appointmentDate")}get timeControl(){return this.appointmentForm.get("appointmentTime")}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=F({type:n,selectors:[["app-update-appointment"]],decls:3,vars:1,consts:[[1,"update-appointment"],[1,"loading-spinner"],[1,"material-icons","loading-icon"],[1,"error-state"],[1,"page-title"],[1,"page-subtitle"],[3,"formGroup"],[3,"dateControl","minDate","dayFilter","isLoading","error"],[3,"timeControl","availableTimeSlots","isLoading","error"],[1,"form-actions"],["type","button",1,"btn","btn--outline",3,"click"],["type","submit",1,"btn","btn--primary",3,"disabled"],[1,"btn","btn--primary",3,"click"]],template:function(e,o){e&1&&(i(0,"div",0),f(1,Z,5,0,"div",1)(2,re,2,1),s()),e&2&&(d(),h(o.isLoading?1:2))},dependencies:[E,$,j,N,U,q,W],styles:["[_ngcontent-%COMP%]:root{--user-panel-surface: var(--surface-primary);--user-panel-surface-alt: color-mix(in srgb, var(--surface-primary) 92%, var(--surface-secondary) 8%);--user-panel-surface-muted: color-mix(in srgb, var(--surface-primary) 85%, var(--surface-secondary) 15%);--user-panel-border: var(--border-subtle);--user-panel-border-strong: var(--border-strong);--user-panel-text: var(--text-primary);--user-panel-text-muted: var(--text-secondary);--user-panel-text-soft: var(--text-muted);--user-panel-primary: var(--color-primary);--user-panel-primary-hover: var(--color-primary-hover);--user-panel-primary-dark: var(--color-primary-dark);--user-panel-primary-soft: color-mix(in srgb, var(--color-primary) 12%, transparent 88%);--user-panel-layer-soft: color-mix(in srgb, var(--color-primary) 10%, transparent 90%);--user-panel-layer-strong: color-mix(in srgb, var(--color-primary) 18%, transparent 82%);--user-panel-success: var(--color-success);--user-panel-success-soft: color-mix(in srgb, var(--color-success) 16%, transparent 84%);--user-panel-warning: var(--color-warning);--user-panel-warning-soft: color-mix(in srgb, var(--color-warning) 16%, transparent 84%);--user-panel-danger: var(--color-error);--user-panel-danger-soft: color-mix(in srgb, var(--color-error) 16%, transparent 84%);--user-panel-info: var(--color-info);--user-panel-info-soft: color-mix(in srgb, var(--color-info) 16%, transparent 84%);--user-panel-shadow-sm: var(--shadow-sm);--user-panel-shadow-md: var(--shadow-md);--user-panel-shadow-lg: var(--shadow-lg);--user-panel-focus-ring: var(--focus-ring);--user-panel-overlay: var(--surface-backdrop);--user-panel-navbar-hover: color-mix(in srgb, var(--color-primary) 12%, transparent 88%);--user-panel-navbar-active: color-mix(in srgb, var(--color-primary) 18%, transparent 82%);--user-panel-navbar-border: color-mix(in srgb, var(--color-primary) 25%, transparent 75%);--user-panel-navbar-gradient: var(--gradient-primary);--user-panel-navbar-text: var(--text-primary);--user-panel-footer-shadow: var(--shadow-sm);--user-panel-footer-button-shadow: color-mix(in srgb, var(--color-primary) 20%, transparent 80%)}[data-theme=dark][_ngcontent-%COMP%]{--user-panel-surface-alt: color-mix(in srgb, var(--surface-primary) 88%, var(--surface-secondary) 12%);--user-panel-surface-muted: color-mix(in srgb, var(--surface-primary) 70%, var(--surface-secondary) 30%);--user-panel-navbar-hover: color-mix(in srgb, var(--color-primary) 20%, transparent 80%);--user-panel-navbar-active: color-mix(in srgb, var(--color-primary) 28%, transparent 72%);--user-panel-footer-shadow: var(--shadow-md)}.icon[_ngcontent-%COMP%]{width:20px;height:20px;stroke-width:2}.btn[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:var(--border-radius-sm);font-weight:500;font-size:14px;cursor:pointer;transition:var(--transition-smooth);border:none;color:var(--text-white)}.btn--primary[_ngcontent-%COMP%]{color:var(--text-white);background:linear-gradient(135deg,var(--user-panel-primary) 0%,var(--user-panel-primary-dark) 100%)}.btn--outline[_ngcontent-%COMP%]{background-color:transparent;color:var(--user-panel-text);border:1px solid var(--user-panel-border)}.btn--outline[_ngcontent-%COMP%]:hover{background-color:var(--user-panel-surface)}.btn--danger[_ngcontent-%COMP%]{background-color:var(--user-panel-danger);color:var(--text-white)}.btn--danger[_ngcontent-%COMP%]:hover{background-color:color-mix(in srgb,var(--user-panel-danger) 95%,black 5%)}.btn--sm[_ngcontent-%COMP%]{padding:6px 12px;font-size:12px}.btn[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{width:16px;height:16px}.btn-icon[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:50%;background-color:transparent;color:var(--user-panel-text-muted);border:none;cursor:pointer;transition:var(--transition-smooth)}.btn-icon[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:flex-start;gap:8px}.btn-icon[_ngcontent-%COMP%]:hover{background-color:var(--user-panel-surface);color:var(--user-panel-primary)}.btn-icon[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{width:18px;height:18px}.empty-state[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;flex-direction:column;padding:60px 20px;text-align:center}.empty-state__icon[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:80px;height:80px;border-radius:50%;background-color:var(--user-panel-layer-soft);color:var(--user-panel-primary);margin-bottom:24px}.empty-state__icon[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{width:40px;height:40px}.empty-state[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:20px;font-weight:600;margin:0 0 8px;color:var(--user-panel-text)}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;color:var(--user-panel-text-muted);margin:0 0 24px}.update-appointment[_ngcontent-%COMP%]{padding:20px;max-width:600px;margin:0 auto}@media (max-width: 479px){.update-appointment[_ngcontent-%COMP%]{padding:16px}}.page-title[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:600;color:var(--user-panel-text);text-align:center;margin-bottom:.5rem}@media (max-width: 479px){.page-title[_ngcontent-%COMP%]{font-size:1.5rem}}.page-subtitle[_ngcontent-%COMP%]{font-size:1rem;color:var(--user-panel-text-muted);text-align:center;margin-bottom:2rem}@media (max-width: 479px){.page-subtitle[_ngcontent-%COMP%]{font-size:.9rem}}.form-actions[_ngcontent-%COMP%]{margin-top:1.5rem}.form-actions[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:flex-end;gap:12px}@media (max-width: 479px){.form-actions[_ngcontent-%COMP%]{flex-direction:column;gap:8px}}.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{padding:10px 16px;font-size:.9rem;border-radius:var(--border-radius-sm)}@media (max-width: 479px){.form-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:100%}}.form-actions[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]{background-color:var(--user-panel-primary);color:var(--text-white);border:none}.form-actions[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]:hover{background-color:var(--user-panel-primary-dark)}.form-actions[_ngcontent-%COMP%]   .btn--primary[disabled][_ngcontent-%COMP%]{background-color:var(--user-panel-text-soft);cursor:not-allowed}.form-actions[_ngcontent-%COMP%]   .btn--outline[_ngcontent-%COMP%]{color:var(--user-panel-primary);border:1px solid var(--user-panel-primary);background:transparent}.form-actions[_ngcontent-%COMP%]   .btn--outline[_ngcontent-%COMP%]:hover{background-color:var(--user-panel-layer-soft)}.loading-spinner[_ngcontent-%COMP%]{text-align:center;padding:2rem;color:var(--user-panel-text-muted)}.loading-spinner[_ngcontent-%COMP%]{display:flex;flex-direction:column}.loading-spinner[_ngcontent-%COMP%]   .loading-icon[_ngcontent-%COMP%]{font-size:2rem;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin-bottom:.5rem}.error-state[_ngcontent-%COMP%]{padding:60px 20px;text-align:center;background-color:var(--user-panel-surface);border-radius:var(--border-radius-md);box-shadow:var(--user-panel-shadow-sm);display:flex;align-items:center;justify-content:center}.error-state[_ngcontent-%COMP%]{display:flex;flex-direction:column}@media (max-width: 479px){.error-state[_ngcontent-%COMP%]{padding:40px 16px}}.error-state[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:20px;font-weight:600;margin:0 0 8px;color:var(--user-panel-text)}@media (max-width: 479px){.error-state[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:18px}}.error-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;color:var(--user-panel-text-muted);margin:0 0 24px}@media (max-width: 479px){.error-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:13px;margin-bottom:16px}}.error-state[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]{background-color:var(--user-panel-primary);color:var(--text-white)}.error-state[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]:hover{background-color:var(--user-panel-primary-dark)}@media (max-width: 479px){.error-state[_ngcontent-%COMP%]   .btn--primary[_ngcontent-%COMP%]{width:100%}}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}"]})};export{Y as UpdateAppointmentComponent};
